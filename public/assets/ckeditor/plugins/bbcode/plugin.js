/*
 Copyright (c) 2003-2012, CKSource - Frederico Knabben. All rights reserved.
 For licensing, see LICENSE.html or http://ckeditor.com/license
*/
(function(){CKEDITOR.on("dialogDefinition",function(e){var t;t=e.data.name,e=e.data.definition,"link"==t?(e.removeContents("target"),e.removeContents("upload"),e.removeContents("advanced"),t=e.getContents("info"),t.remove("emailSubject"),t.remove("emailBody")):"image"==t&&(e.removeContents("advanced"),t=e.getContents("Link"),t.remove("cmbTarget"),t=e.getContents("info"),t.remove("txtAlt"),t.remove("basic"))});var e={b:"strong",u:"u",i:"em",color:"span",size:"span",quote:"blockquote",code:"code",url:"a",email:"span",img:"span","*":"li",list:"ol"},t={strong:"b",b:"b",u:"u",em:"i",i:"i",code:"code",li:"*"},n={strong:"b",em:"i",u:"u",li:"*",ul:"list",ol:"list",code:"code",a:"link",img:"img",blockquote:"quote"},r={color:"color",size:"font-size"},i={url:"href",email:"mailhref",quote:"cite",list:"listType"},s=CKEDITOR.dtd,o=CKEDITOR.tools.extend({table:1},s.$block,s.$listItem,s.$tableContent,s.$list),u=/\s*(?:;\s*|$)/,a={smiley:":)",sad:":(",wink:";)",laugh:":D",cheeky:":P",blush:":*)",surprise:":-o",indecision:":|",angry:">:(",angel:"o:)",cool:"8-)",devil:">:-)",crying:";(",kiss:":-*"},f={},l=[],c;for(c in a)f[a[c]]=c,l.push(a[c].replace(/\(|\)|\:|\/|\*|\-|\|/g,function(e){return"\\"+e}));var l=RegExp(l.join("|"),"g"),h=function(){var e=[],t={nbsp:" ",shy:"­",gt:">",lt:"<"},n;for(n in t)e.push(n);return e=RegExp("&("+e.join("|")+");","g"),function(n){return n.replace(e,function(e,n){return t[n]})}}();CKEDITOR.BBCodeParser=function(){this._={bbcPartsRegex:/(?:\[([^\/\]=]*?)(?:=([^\]]*?))?\])|(?:\[\/([a-z]{1,16})\])/ig}},CKEDITOR.BBCodeParser.prototype={parse:function(t){for(var n,s,o=0;n=this._.bbcPartsRegex.exec(t);){s=n.index,s>o&&this.onText(t.substring(o,s),1),o=this._.bbcPartsRegex.lastIndex;if((s=(n[1]||n[3]||"").toLowerCase())&&!e[s])this.onText(n[0]);else if(n[1]){var a=e[s],f={},l={};if(n=n[2])if("list"==s&&(isNaN(n)?/^[a-z]+$/.test(n)?n="lower-alpha":/^[A-Z]+$/.test(n)&&(n="upper-alpha"):n="decimal"),r[s]){"size"==s&&(n+="%"),l[r[s]]=n,n=f;var c="",h=void 0;for(h in l)var p=(h+":"+l[h]).replace(u,";"),c=c+p;n.style=c}else i[s]&&(f[i[s]]=n);if("email"==s||"img"==s)f.bbcode=s;this.onTagOpen(a,f,CKEDITOR.dtd.$empty[a])}else n[3]&&this.onTagClose(e[s])}t.length>o&&this.onText(t.substring(o,t.length),1)}},CKEDITOR.htmlParser.fragment.fromBBCode=function(e){function t(e){if(0<a.length)for(var t=0;t<a.length;t++){var n=a[t],r=n.name,i=CKEDITOR.dtd[r],s=h.name&&CKEDITOR.dtd[h.name];(!s||s[r])&&(!e||!i||i[e]||!CKEDITOR.dtd[e])&&(n=n.clone(),n.parent=h,h=n,a.splice(t,1),t--)}}function r(e,t){var r=h.children.length,i=0<r&&h.children[r-1],r=!i&&p.getRule(n[h.name],"breakAfterOpen"),i=i&&i.type==CKEDITOR.NODE_ELEMENT&&p.getRule(n[i.name],"breakAfterClose"),s=e&&p.getRule(n[e],t?"breakBeforeClose":"breakBeforeOpen");c&&(r||i||s)&&c--,c&&e in o&&c++;for(;c&&c--;)h.children.push(new CKEDITOR.htmlParser.element("br"))}function i(e,t){r(e.name,1);var t=t||h||u,n=t.children.length;e.previous=0<n&&t.children[n-1]||null,e.parent=t,t.children.push(e),e.returnPoint&&(h=e.returnPoint,delete e.returnPoint)}var s=new CKEDITOR.BBCodeParser,u=new CKEDITOR.htmlParser.fragment,a=[],c=0,h=u,d;s.onTagOpen=function(e,n,o){var u=new CKEDITOR.htmlParser.element(e,n);if(CKEDITOR.dtd.$removeEmpty[e])a.push(u);else{var f=h.name,l=f&&(CKEDITOR.dtd[f]||(h._.isBlockLike?CKEDITOR.dtd.div:CKEDITOR.dtd.span));if(l&&!l[e]){var l=!1,c;e==f?i(h,h.parent):(e in CKEDITOR.dtd.$listItem?(s.onTagOpen("ul",{}),c=h):(i(h,h.parent),a.unshift(h)),l=!0),h=c?c:h.returnPoint||h.parent;if(l){s.onTagOpen.apply(this,arguments);return}}t(e),r(e),u.parent=h,u.returnPoint=d,d=0,u.isEmpty?i(u):h=u}},s.onTagClose=function(e){for(var t=a.length-1;0<=t;t--)if(e==a[t].name){a.splice(t,1);return}for(var n=[],r=[],s=h;s.type&&s.name!=e;)s._.isBlockLike||r.unshift(s),n.push(s),s=s.parent;if(s.type){for(t=0;t<n.length;t++)e=n[t],i(e,e.parent);h=s,i(s,s.parent),s==h&&(h=h.parent),a=a.concat(r)}},s.onText=function(e){var n=CKEDITOR.dtd[h.name];if(!n||n["#"])r(),t(),e.replace(/([\r\n])|[^\r\n]*/g,function(e,t){if(void 0!==t&&t.length)c++;else if(e.length){var n=0;e.replace(l,function(t,r){i(new CKEDITOR.htmlParser.text(e.substring(n,r)),h),i(new CKEDITOR.htmlParser.element("smiley",{desc:f[t]}),h),n=r+t.length}),n!=e.length&&i(new CKEDITOR.htmlParser.text(e.substring(n,e.length)),h)}})};for(s.parse(CKEDITOR.tools.htmlEncode(e));h.type;)e=h.parent,i(h,e),h=e;return u};var p=new(CKEDITOR.tools.createClass({$:function(){this._={output:[],rules:[]},this.setRules("list",{breakBeforeOpen:1,breakAfterOpen:1,breakBeforeClose:1,breakAfterClose:1}),this.setRules("*",{breakBeforeOpen:1,breakAfterOpen:0,breakBeforeClose:1,breakAfterClose:0}),this.setRules("quote",{breakBeforeOpen:1,breakAfterOpen:0,breakBeforeClose:0,breakAfterClose:1})},proto:{setRules:function(e,t){var n=this._.rules[e];n?CKEDITOR.tools.extend(n,t,!0):this._.rules[e]=t},getRule:function(e,t){return this._.rules[e]&&this._.rules[e][t]},openTag:function(t,n){if(t in e){this.getRule(t,"breakBeforeOpen")&&this.lineBreak(1),this.write("[",t);var r=n.option;r&&this.write("=",r),this.write("]"),this.getRule(t,"breakAfterOpen")&&this.lineBreak(1)}else"br"==t&&this._.output.push("\n")},openTagClose:function(){},attribute:function(){},closeTag:function(t){t in e&&(this.getRule(t,"breakBeforeClose")&&this.lineBreak(1),"*"!=t&&this.write("[/",t,"]"),this.getRule(t,"breakAfterClose")&&this.lineBreak(1))},text:function(e){this.write(e)},comment:function(){},lineBreak:function(){!this._.hasLineBreak&&this._.output.length&&(this.write("\n"),this._.hasLineBreak=1)},write:function(){this._.hasLineBreak=0,this._.output.push(Array.prototype.join.call(arguments,""))},reset:function(){this._.output=[],this._.hasLineBreak=0},getHtml:function(e){var t=this._.output.join("");return e&&this.reset(),h(t)}}}));CKEDITOR.plugins.add("bbcode",{requires:"entities",beforeInit:function(e){CKEDITOR.tools.extend(e.config,{enterMode:CKEDITOR.ENTER_BR,basicEntities:!1,entities:!1,fillEmptyBlocks:!1},!0)},init:function(e){function n(e){var t=e.data,e=CKEDITOR.htmlParser.fragment.fromBBCode(e.data.dataValue),n=new CKEDITOR.htmlParser.basicWriter;e.writeHtml(n,i),e=n.getHtml(!0),t.dataValue=e}var r=e.config,i=new CKEDITOR.htmlParser.filter;i.addRules({elements:{blockquote:function(e){var t=new CKEDITOR.htmlParser.element("div");t.children=e.children,e.children=[t];if(t=e.attributes.cite){var n=new CKEDITOR.htmlParser.element("cite");n.add(new CKEDITOR.htmlParser.text(t.replace(/^"|"$/g,""))),delete e.attributes.cite,e.children.unshift(n)}},span:function(e){var t;if(t=e.attributes.bbcode)"img"==t?(e.name="img",e.attributes.src=e.children[0].value,e.children=[]):"email"==t&&(e.name="a",e.attributes.href="mailto:"+e.children[0].value),delete e.attributes.bbcode},ol:function(e){e.attributes.listType?"decimal"!=e.attributes.listType&&(e.attributes.style="list-style-type:"+e.attributes.listType):e.name="ul",delete e.attributes.listType},a:function(e){e.attributes.href||(e.attributes.href=e.children[0].value)},smiley:function(e){e.name="img";var t=e.attributes.desc,n=r.smiley_images[CKEDITOR.tools.indexOf(r.smiley_descriptions,t)],n=CKEDITOR.tools.htmlEncode(r.smiley_path+n);e.attributes={src:n,"data-cke-saved-src":n,title:t,alt:t}}}}),e.dataProcessor.htmlFilter.addRules({elements:{$:function(n){var r=n.attributes,i=CKEDITOR.tools.parseCssText(r.style),s,o=n.name;if(o in t)o=t[o];else if("span"==o){if(s=i.color)o="color",s=CKEDITOR.tools.convertRgbToHex(s);else if(s=i["font-size"])if(r=s.match(/(\d+)%$/))s=r[1],o="size"}else if("ol"==o||"ul"==o){if(s=i["list-style-type"])switch(s){case"lower-alpha":s="a";break;case"upper-alpha":s="A"}else"ol"==o&&(s=1);o="list"}else if("blockquote"==o){try{var u=n.children[0],f=n.children[1],l="cite"==u.name&&u.children[0].value;l&&(s='"'+l+'"',n.children=f.children)}catch(c){}o="quote"}else if("a"==o){if(s=r.href)-1!==s.indexOf("mailto:")?(o="email",n.children=[new CKEDITOR.htmlParser.text(s.replace("mailto:",""))],s=""):((o=1==n.children.length&&n.children[0])&&o.type==CKEDITOR.NODE_TEXT&&o.value==s&&(s=""),o="url")}else if("img"==o){n.isEmpty=0,i=r["data-cke-saved-src"]||r.src,r=r.alt;if(i&&-1!=i.indexOf(e.config.smiley_path)&&r)return new CKEDITOR.htmlParser.text(a[r]);n.children=[new CKEDITOR.htmlParser.text(i)]}return n.name=o,s&&(n.attributes.option=s),null},br:function(e){if((e=e.next)&&e.name in o)return!1}}},1),e.dataProcessor.writer=p,e.elementMode==CKEDITOR.ELEMENT_MODE_INLINE?e.once("contentDom",function(){e.on("setData",n)}):e.on("setData",n)},afterInit:function(e){var t;e._.elementsPath&&(t=e._.elementsPath.filters)&&t.push(function(t){var r=t.getName(),i=n[r]||!1;return"link"==i&&0===t.getAttribute("href").indexOf("mailto:")?i="email":"span"==r?t.getStyle("font-size")?i="size":t.getStyle("color")&&(i="color"):"img"==i&&(t=t.data("cke-saved-src")||t.getAttribute("src"))&&0===t.indexOf(e.config.smiley_path)&&(i="smiley"),i})}})})();